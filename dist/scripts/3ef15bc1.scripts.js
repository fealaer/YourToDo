"use strict";angular.module("LocalStorageModule").value("prefix","mainApp"),angular.module("mainApp",["ngCookies","ngResource","ngSanitize","ngRoute","LocalStorageModule","ui.bootstrap","sharedApp"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"/views/main/tasks.html",controller:"TasksCtrl"}).when("/signIn",{templateUrl:"/views/main/signIn.html",controller:"AuthCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","$http","Auth",function(a,b,c,d){a.$on("$routeChangeStart",function(a,c){d.isLoggedIn()||"/views/main/signIn.html"===c.templateUrl||b.path("/signIn")})}]),angular.module("mainApp").controller("TasksCtrl",["$scope","$location","Auth","Tasks",function(a,b,c,d){function e(){var b={};c.getToken(function(c,e){c||(b={Authorization:e}),d(b).queryByField({field:"userId",value:a.user._id}).$promise.then(function(b){200===b.status.code&&(a.tasks=b.result,a.tasks.push(angular.copy(f)))})})}a.user=c.getUser(),c.subscribe(a,function(){a.user=c.getUser()}),a.signOutBtn=function(){c.signOut(function(c){c?a.error={error:!0,message:c.message}:b.path("/signIn")})};var f={userId:a.user._id,task:"",priority:"low",status:!1};a.tasks=[],a.submit=function(b){b._id?a.edit(b):a.add(b)},a.add=function(b){b.userId=a.user._id;var e={};c.getToken(function(c,g){c||(e={Authorization:g}),d(e).save(b).$promise.then(function(b){200===b.status.code&&(a.tasks.pop(),a.tasks.push(b.result),a.tasks.push(angular.copy(f)))})})},a.edit=function(a){var b={};c.getToken(function(c,e){c||(b={Authorization:e}),d(b).update(a).$promise.then(function(a){200===a.status.code})})},a.delete=function(b){var e={};c.getToken(function(c,f){c||(e={Authorization:f}),d(e).delete({_id:b._id,userId:a.user._id}).$promise.then(function(c){if(200===c.status.code){var d=a.tasks.indexOf(b);-1!=d&&a.tasks.splice(d,1)}})})},e()}]),angular.module("mainApp").controller("AuthCtrl",["$scope","$location","Auth",function(a,b,c){c.isLoggedIn()&&b.path("/");var d={error:!1};a.error=d,a.data={},a.$watch("data",function(){a.error=d},!0),c.subscribe(a,function(){b.path(c.isLoggedIn()?"/":"/signIn")}),a.logInBtn=function(b){c.signIn(b,function(b){b&&(a.error={error:!0,message:b.message})})},a.signUpBtn=function(b){c.signUp(b,function(b){b&&(a.error={error:!0,message:b.message})})}}]),angular.module("LocalStorageModule").value("prefix","sharedApp"),angular.module("sharedApp",["ngCookies","ngResource","ngSanitize","LocalStorageModule"]),angular.module("sharedApp").service("Auth",["$rootScope","$http","$cookies","localStorageService",function a(b,c,d,e){function f(a){return new Date((new Date).getTime()+1e3*(a-300)).getTime()}function g(){e.remove("user"),e.remove("tokens")}this.eventName="Auth.changes";var h="webAppV1",i="verySmallSecret",j={};a.prototype.isLoggedIn=function(){return e.get("user")?!0:!1},a.prototype.getUser=function(){return e.get("user")||j},a.prototype.signUp=function(b,d){c.post("/register",b).success(function(c){200!==c.status.code?d(c.error,null):a.prototype.createToken(b,function(b){b?d(b,null):(d(null,c.result),e.set("user",c.result),a.prototype.broadcast())})})},a.prototype.signIn=function(b,d){c.post("/login",b).success(function(c){200!==c.status.code?d(c.error,null):a.prototype.createToken(b,function(b){b?d(b,null):(e.set("user",c.result),d(null,c.result),a.prototype.broadcast())})})},a.prototype.signOut=function(b){var d={userId:e.get("user")._id};c.post("/logout",d).success(function(c){200!==c.status.code?b(c.error,null):(g(),a.prototype.broadcast(),b(null,c.result))})},a.prototype.createToken=function(a,b){a.grant_type="password",a.client_id=h,a.client_secret=i,c.post("/oauth/token",a).success(function(a){a.error?b(a.error,null):(a.expired_at=f(a.expires_in),e.set("tokens",a),b(null,a))})},a.prototype.refreshToken=function(a){var b={grant_type:"refresh_token",client_id:h,client_secret:i};b.refresh_token=e.get("tokens").refresh_token,c.post("/oauth/token",b).success(function(b){b.error?a(b.error,null):(b.expired_at=f(b.expires_in),e.set("tokens",b),a(null,b))})},a.prototype.subscribe=function(b,c){b.$on(a.eventName,c)},a.prototype.broadcast=function(){b.$broadcast(a.eventName)},a.prototype.getToken=function(b){var c=e.get("tokens");c?c.expired_at<(new Date).getTime()?a.prototype.refreshToken(function(a,c){a?b(a,null):b(null,c.token_type+" "+c.access_token)}):b(null,c.token_type+" "+c.access_token):b({},null)}}]),angular.module("sharedApp").factory("Tasks",["$resource",function(a){return function(b){return a("/api/v0/tasks/:_id/:userId",{},{save:{method:"POST",isArray:!1,headers:b||{}},"delete":{method:"DELETE",isArray:!1,headers:b||{}},queryByField:{method:"GET",url:"/api/v0/tasks/:field/:value",isArray:!1,headers:b||{}},update:{method:"PUT",url:"/api/v0/tasks",isArray:!1,headers:b||{}}})}}]);